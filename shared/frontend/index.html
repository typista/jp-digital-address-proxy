<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>郵便番号から住所入力</title>
  <style>
    body { font-family: sans-serif; max-width: 720px; margin: 40px auto; padding: 0 16px; }
    label { display: block; margin-top: 16px; font-weight: 600; }
    input, select { width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    button { margin-top: 16px; padding: 10px 14px; font-size: 16px; cursor: pointer; }
    .hint { color: #666; font-size: 13px; margin-top: 6px; }
    .error { color: #b00020; margin-top: 12px; }
    .ok { color: #0a7a0a; margin-top: 12px; }
  </style>
</head>
<body>

  <h1>郵便番号から住所を取得</h1>

  <!-- ★ autocomplete対策：form側もoff -->
  <form id="addrForm" autocomplete="off">
    <label for="zipcode">郵便番号（ハイフンあり/なしOK）</label>

    <!-- ★ autocomplete対策：nameを住所っぽくしない -->
    <input
      id="zipcode"
      name="z"
      type="text"
      inputmode="numeric"
      placeholder="例：102-0082 または 1020082"
      autocomplete="off"
    />
    <div class="hint">入力後「住所を取得」または Enter キーで取得します。</div>

    <button id="fetchBtn" type="button">住所を取得</button>

    <div id="message"></div>

    <hr style="margin: 24px 0;" />

    <!-- ① 都道府県：プルダウン -->
    <label for="pref">都道府県</label>
    <select id="pref" name="p" autocomplete="new-password">
      <option value="">選択してください</option>
      <option value="01">北海道</option>
      <option value="02">青森県</option>
      <option value="03">岩手県</option>
      <option value="04">宮城県</option>
      <option value="05">秋田県</option>
      <option value="06">山形県</option>
      <option value="07">福島県</option>
      <option value="08">茨城県</option>
      <option value="09">栃木県</option>
      <option value="10">群馬県</option>
      <option value="11">埼玉県</option>
      <option value="12">千葉県</option>
      <option value="13">東京都</option>
      <option value="14">神奈川県</option>
      <option value="15">新潟県</option>
      <option value="16">富山県</option>
      <option value="17">石川県</option>
      <option value="18">福井県</option>
      <option value="19">山梨県</option>
      <option value="20">長野県</option>
      <option value="21">岐阜県</option>
      <option value="22">静岡県</option>
      <option value="23">愛知県</option>
      <option value="24">三重県</option>
      <option value="25">滋賀県</option>
      <option value="26">京都府</option>
      <option value="27">大阪府</option>
      <option value="28">兵庫県</option>
      <option value="29">奈良県</option>
      <option value="30">和歌山県</option>
      <option value="31">鳥取県</option>
      <option value="32">島根県</option>
      <option value="33">岡山県</option>
      <option value="34">広島県</option>
      <option value="35">山口県</option>
      <option value="36">徳島県</option>
      <option value="37">香川県</option>
      <option value="38">愛媛県</option>
      <option value="39">高知県</option>
      <option value="40">福岡県</option>
      <option value="41">佐賀県</option>
      <option value="42">長崎県</option>
      <option value="43">熊本県</option>
      <option value="44">大分県</option>
      <option value="45">宮崎県</option>
      <option value="46">鹿児島県</option>
      <option value="47">沖縄県</option>
    </select>

    <label for="city">市区町村</label>
    <!-- ★② autocomplete対策：住所判定されにくい -->
    <input id="city" name="c" type="text" autocomplete="new-password" />

    <label for="street">番地</label>
    <!-- ★② autocomplete対策 -->
    <input id="street" name="s" type="text" autocomplete="new-password"
           placeholder="（取得データが町名までの場合は町名が入ります）" />

    <!-- ③ 文言変更 -->
    <label for="building">建物名または部屋番号</label>
    <!-- ★② autocomplete対策 -->
    <input id="building" name="b" type="text" autocomplete="new-password"
           placeholder="例：○○マンション 101" />
  </form>

<script>
  const API_BASE = "./api";

  const $ = (id) => document.getElementById(id);

  const zipcodeEl = $("zipcode");
  const fetchBtn = $("fetchBtn");
  const msgEl = $("message");

  const prefEl = $("pref");
  const cityEl = $("city");
  const streetEl = $("street");
  const buildingEl = $("building");

  function setMessage(text, type = "") {
    msgEl.className = type;
    msgEl.textContent = text;
  }

  function normalizeZip(zip) {
    return (zip || "").replace(/[^\d]/g, "");
  }

  async function fetchAddress() {
    setMessage("");
    const zip = normalizeZip(zipcodeEl.value);

    if (zip.length !== 7) {
      setMessage("郵便番号は7桁で入力してください（例：1020082）", "error");
      return;
    }

    fetchBtn.disabled = true;
    fetchBtn.textContent = "取得中...";

    try {
      const url = `${API_BASE}?search_code=${encodeURIComponent(zip)}`;
      const res = await fetch(url, { method: "GET" });

      if (!res.ok) throw new Error(`APIエラー: ${res.status}`);

      const data = await res.json();

      if (!data.addresses || data.addresses.length === 0) {
        setMessage("該当する住所が見つかりませんでした。", "error");
        return;
      }

      const a = data.addresses[0];

      // ① 都道府県はpref_codeでプルダウン選択
      // API側が "14" のように2桁ならそのまま、"014"等なら調整してください
      const prefCode = (a.pref_code || "").padStart(2, "0");
      prefEl.value = prefCode;

      cityEl.value = a.city_name || "";

      // ※現状は town_name までなので「番地」欄に入れる（必要なら結合ロジックに変更可能）
      streetEl.value = a.town_name || "";

      // ② 自動補完ブロック：ここでは建物欄は触らない（ブラウザが勝手に入れても上書きしない）
      // buildingEl.value = "";

      setMessage("住所を取得しました。必要に応じて番地・建物名を補完してください。", "ok");
      streetEl.focus();

    } catch (err) {
      console.error(err);
      setMessage("取得に失敗しました。APIが起動しているか、CORSなどの設定をご確認ください。", "error");
    } finally {
      fetchBtn.disabled = false;
      fetchBtn.textContent = "住所を取得";
    }
  }

  fetchBtn.addEventListener("click", fetchAddress);

  zipcodeEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      fetchAddress();
    }
  });

  // ② さらに強めたい場合（任意）：
  // 郵便番号入力欄にフォーカスしたとき、他項目を一旦空にする（オートフィル対策の補助）
  // zipcodeEl.addEventListener("focus", () => {
  //   // 既に入力している場合は消さない方が良いなら、この処理は外してください
  //   // prefEl.value = "";
  //   // cityEl.value = "";
  //   // streetEl.value = "";
  //   // buildingEl.value = "";
  // });
</script>

</body>
</html>
